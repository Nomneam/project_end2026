{% extends "layout/reporter-layout.html" %}

{% block title %}หน้ารวมข่าว{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/news-list.css') }}">
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h2 class="mb-1">หน้ารวมข่าว</h2>
      <div class="text-muted">แสดงเฉพาะข่าวที่เผยแพร่แล้ว</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <span>ข่าวทั้งหมด (เผยแพร่แล้ว)</span>

      <form class="d-flex gap-2" method="GET">
        <input type="text" class="form-control" name="q" value="{{ q or '' }}" placeholder="ค้นหาหัวข้อข่าว...">
        <button class="btn btn-danger" type="submit"><i class="bi bi-search"></i> ค้นหา</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('news_list.news_list_page') }}">ล้างค่า</a>
      </form>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle news-table">
          <thead class="news-thead">
            <tr>
              <th class="text-center">หัวข้อข่าว</th>
              <th class="text-center">ชนิดข่าว</th>
              <th class="text-center">ประเภท</th>
              <th class="text-center">วันที่เผยแพร่</th>
              <th class="text-center">สถานะ</th>
              <th class="text-center">ผู้เขียน</th>
              <th class="text-center">ดูรายละเอียด</th>
            </tr>
          </thead>

          <tbody>
            {% for n in rows %}
            <tr>
              <td class="fw-semibold">{{ n.news_title }}</td>

              <td class="text-center">
                {% if (n.is_featured or 0) == 1 %}
                  <span class="badge bg-danger">ข่าวยอดฮิต</span>
                {% else %}
                  <span class="badge bg-secondary">ข่าวทั่วไป</span>
                {% endif %}
              </td>

              <td class="text-center">{{ n.category_name or "-" }}</td>

              <td class="text-center">
                {% if n.published_at %}
                  {{ n.published_at.strftime("%d/%m/%Y") }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-center">
                <span class="status-badge status-published">เผยแพร่แล้ว</span>
              </td>

              <td class="text-center">
                {{ (n.author_fname or "") ~ " " ~ (n.author_lname or "") }}
              </td>

              <td class="text-center">
                <button type="button"
                        class="btn btn-sm btn-info btn-view-public"
                        data-id="{{ n.news_id }}"
                        title="ดูรายละเอียด">
                  <i class="bi bi-eye"></i>
                </button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                ยังไม่มีข่าวที่เผยแพร่
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Pagination #}
      {% if total_pages > 1 %}
      <div class="pagination-wrap mt-3">
        <nav aria-label="Pagination">
          <ul class="pagination mb-0">

            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('news_list.news_list_page', page=page-1, q=q) }}">&laquo;</a>
            </li>

            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
              <a class="page-link"
                 href="{{ url_for('news_list.news_list_page', page=p, q=q) }}">{{ p }}</a>
            </li>
            {% endfor %}

            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('news_list.news_list_page', page=page+1, q=q) }}">&raquo;</a>
            </li>

          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ✅ View Modal (Read-only) -->
<div class="modal fade" id="publicViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-text me-1"></i> ดูรายละเอียดข่าว</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <div class="col-md-8">
            <label class="form-label">หัวข้อข่าว</label>
            <input class="form-control" id="pv_title" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">ชนิดข่าว</label>
            <input class="form-control" id="pv_kind" readonly>
          </div>

          <div class="col-md-6">
            <label class="form-label">ประเภทข่าวหลัก</label>
            <input class="form-control" id="pv_category" readonly>
          </div>

          <div class="col-md-6">
            <label class="form-label">ประเภทย่อย</label>
            <input class="form-control" id="pv_subcategory" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">สถานะ</label>
            <input class="form-control" id="pv_status" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">วันที่เผยแพร่</label>
            <input class="form-control" id="pv_published_at" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">ผู้เขียน</label>
            <input class="form-control" id="pv_author" readonly>
          </div>

          <div class="col-12">
            <label class="form-label">เนื้อหาข่าว</label>
            <textarea class="form-control" id="pv_content" rows="9" readonly></textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label">รูปปก</label>
            <div class="border rounded p-2 text-center bg-light">
              <img id="pv_cover_img" src="" alt="cover" style="max-height:260px; max-width:100%; display:none;">
              <div id="pv_cover_empty" class="text-muted">ไม่มีรูปปก</div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">รูปภาพรอง</label>
            <div id="pv_sub_images" class="d-flex flex-wrap gap-2"></div>
            <div id="pv_sub_images_empty" class="text-muted">ไม่มีรูปภาพรอง</div>
          </div>

          <div class="col-12">
            <label class="form-label">วิดีโอ (URL)</label>
            <input class="form-control" id="pv_video_url" readonly>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/news-list.js') }}"></script>
{% endblock %}
